name: Generate Roast Graphs

on:
  push:
    paths:
      - '**/*.alog' # .alogファイルが変更された時のみ実行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 画像をコミットするために書き込み権限が必要

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate Graphs
        run: |
          # エラーがあれば即停止
          set -e

          # pngディレクトリを作成
          mkdir -p png

          # 全ての.alogファイルを検索し、画像生成スクリプトを実行
          find . -name "*.alog" | while read filename; do
            # ファイル名（拡張子なし）を取得
            basename=$(basename "$filename" .alog)
            # pngディレクトリ内のパスを作成
            pngname="png/${basename}.png"

            # 画像が既に存在する場合はスキップ
            if [ -f "$pngname" ]; then
              echo "Skipping $filename (Already exists)"
              continue
            fi

            # 画像の生成
            echo "Processing $filename -> $pngname"
            python render_graph.py "$filename" "$pngname"
          done

      - name: Commit and Push changes
        run: |
          git config --global user.email "ikuto0608@me.com"
          git config --global user.name "ikuto0608"

          # pngディレクトリ以下の変更をステージング
          git add png/

          # ステージングされた変更があるか確認してからコミット
          if ! git diff --cached --quiet; then
            echo "Changes detected, committing..."
            git commit -m "Add roast graphs to png/ [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
